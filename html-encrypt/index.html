<!DOCTYPE html>
<html lang="zh-tw">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Content Security Policy 設定禁止內嵌該網頁到其他網頁中 -->
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none';">


  <title>加密工具</title>
  <!-- 連結外部css風格 -->
  <link rel="stylesheet" href="https://v8953014.github.io/www-objects/html-encrypt/styles_01.css">
</head>

<body>
  <header>
    <h1>HTML 加密工具</h1>
  </header>
  <div class="container">
    <!-- 用於輸入HTML的文本區域 -->
    <textarea id="inputHTML" rows="10" placeholder="在這裡輸入你的HTML內容..."></textarea>
    <div class="button-group">
      <!-- 按鈕觸發加密函數 -->
      <button onclick="loadSecretKeyAndEncryptHTML()">加密</button>
      <!-- 預覽加密後的HTML -->
      <button class="preview-button" onclick="previewHTML()">預覽</button>
      <!-- 下載加密後的HTML -->
      <button class="download-button" onclick="downloadHTML()">下載</button>
    </div>
    <!-- 顯示加密後的HTML的文本區域 -->
    <textarea id="encryptedHTML" rows="10" placeholder="加密後的HTML將在這裡顯示..." readonly></textarea>
    <h2>解密結果</h2>
    <div class="button-group">
      <!-- 按鈕觸發解密函數 -->
      <button onclick="decryptHTML()">解密</button>
    </div>
    <!-- 顯示解密後的HTML的文本區域 -->
    <textarea id="decryptedHTML" rows="10" placeholder="解密後的HTML將在這裡顯示..." readonly></textarea>
  </div>
  
  <!-- 顯示頁腳 -->
  <footer>
    © 2023 加密工具。保留所有權利。
  </footer>

  <!-- 引入 CryptoJS 函數庫 -->
  <script src="https://v8953014.github.io/www-objects/html-encrypt/_js/crypto-js.js"></script>
  <script src="https://v8953014.github.io/www-objects/html-encrypt/_js/encrypt.js"></script>
  <script src="https://v8953014.github.io/www-objects/html-encrypt/_js/decrypt.js"></script>
  <script>
    var secret_key; // 宣告全域變數來存儲密鑰

    // 異步加載外部網址的文件並加密HTML
    function loadSecretKeyAndEncryptHTML() {
      var inputHTML = document.getElementById("inputHTML").value;
      // 檢查字符數是否超過2500
      if (inputHTML.length > 3000) {
        alert("字符數超過3000，無法加密！");
        return;
      }

      var script = document.createElement('script');
	  // 異步載入外部網址的JavaScript文件
      script.src = 'https://v8953014.github.io/www-objects/html-encrypt/_js/webkey.js'; 
      script.onload = function() {
        encryptHTML(secret_key);
      };
      document.body.appendChild(script);
    }

    // 在這個函數中，我們使用AES加密算法對HTML內容進行加密
    function encryptHTML(secretKey) {
      var inputHTML = document.getElementById("inputHTML").value;
      var headStart = inputHTML.indexOf("<head>") + 6;
      var bodyEnd = inputHTML.indexOf("</body>");
      // 在body的起始位置插入script，禁止右鍵、禁止F1~F12快捷鍵、禁止[開發人員工具]視窗
      var scriptToAdd = '\n<' + 'script>' + 'document.addEventListener("contextmenu", e => e.preventDefault());document.addEventListener("keydown", e => {if (e.ctrlKey || e.shiftKey || e.altKey || (e.keyCode >= 112 && e.keyCode <= 123)) {e.preventDefault();}});setInterval(() => {const t = 160;if (window.outerWidth - window.innerWidth > t || window.outerHeight - window.innerHeight > t) {window.location.replace("http://www.example.com/404.html");}}, 300);' + '</script' + '>\n';
      var contentToEncrypt = inputHTML.slice(headStart, bodyEnd);
      contentToEncrypt = contentToEncrypt.slice(0, 1) + scriptToAdd + contentToEncrypt.slice(1);
      var encryptedContent = CryptoJS.AES.encrypt(contentToEncrypt, secretKey).toString();
      // 額外的加密腳本
      var additionalScripts = '\n<' + 'script src="https://v8953014.github.io/www-objects/html-encrypt/_js/crypto-js.js"></script' + '>' + '\n<' + 'script src="https://v8953014.github.io/www-objects/html-encrypt/_js/DE4.js"></script' + '>';
      // 構建加密後的HTML碼
      var encryptedHTML = '<!DOCTYPE html>\n<html lang="zh-tw">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">' + encryptedContent + '</body>' + additionalScripts + '\n</html>';
      // 將加密後的HTML顯示在文本區域
      document.getElementById("encryptedHTML").value = encryptedHTML;
    }

    // 解密HTML
    function decryptHTML() {
      var inputHTML = document.getElementById("encryptedHTML").value;
      var metaViewportIndex = inputHTML.indexOf('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
      var headStart = metaViewportIndex + '<meta name="viewport" content="width=device-width, initial-scale=1.0">'.length;

      var bodyEnd = inputHTML.indexOf("</body>");
      var encryptedContent = inputHTML.slice(headStart, bodyEnd);

      // 解密密文時使用從外部載入的實際密鑰
      var decryptedContent = CryptoJS.AES.decrypt(encryptedContent, secret_key).toString(CryptoJS.enc.Utf8);

      // 移除特定腳本
      decryptedContent = decryptedContent.replace(/\n?<script>.+<\/script>\n?/g, '');

      // 重新構建解密後的HTML碼，插入必要的meta標籤
      var decryptedHTML = '<!DOCTYPE html>\n<html lang="zh-tw">\n<head>' + decryptedContent + '</body>\n</html>';

      // 將解密後的HTML顯示在文本區域
      document.getElementById("decryptedHTML").value = decryptedHTML;
    }

    // 獲取格式化的當前日期作為下載文件的名稱
    function getFormattedDate() {
      var now = new Date();
      var year = now.getFullYear();
      var month = (now.getMonth() + 1).toString().padStart(2, '0');
      var day = now.getDate().toString().padStart(2, '0');
      var hours = now.getHours().toString().padStart(2, '0');
      var minutes = now.getMinutes().toString().padStart(2, '0');
      return 'en' + year + month + day + '-' + hours + minutes + '.html';
    }

    // 定义一个全局变量来存储预览窗口
    var previewWindow;

    // 预览加密后的HTML
    function previewHTML() {
    var encryptedHTML = document.getElementById("encryptedHTML").value;
  
    // 检查加密欄是否為空
    if (encryptedHTML.trim() === "") {
    // 如果加密欄為空，不執行預覽動作
    alert("加密欄無任何資料...");
    return;
    }
  
    // 如果窗口已存在，更新内容并将焦点设置到窗口上
    if (previewWindow && !previewWindow.closed) {
      previewWindow.document.body.innerHTML = encryptedHTML;
      previewWindow.focus();
    } else {
    // 如果窗口不存在，创建新窗口并将焦点设置到窗口上
    var screenWidth = window.innerWidth;
    var screenHeight = window.innerHeight;
    var leftPosition = (screenWidth - 512) / 2;
    var topPosition = (screenHeight - 382) / 2;
    previewWindow = window.open("", "_blank", "width=512,height=382,left=" + leftPosition + ",top=" + topPosition);
    previewWindow.document.write(encryptedHTML);
    previewWindow.focus();
    }
  }




    // 下載加密後的HTML文件
    function downloadHTML() {
      var encryptedHTML = document.getElementById("encryptedHTML").value;

      // 如果加密內容為空，拋出錯誤訊息
      if (!encryptedHTML.trim()) {
        alert("加密框內沒有任何內容！");
        return;
      }

      // 檢查檔案大小是否超過3KB
      var fileSizeInBytes = new Blob([encryptedHTML], { type: "text/html" }).size;
      if (fileSizeInBytes > 5000) {
        alert("檔案大小超過5KB，無法下載！");
        return;
      }

      // 創建下載連結並模擬點擊以下載文件
      var downloadLink = document.createElement("a");
      downloadLink.href = "data:text/html;charset=utf-8," + encodeURIComponent(encryptedHTML);
      downloadLink.download = getFormattedDate();
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
  </script>
</body>
</html>

